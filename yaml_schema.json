from pathlib import Path

import pytest

from tests.utils.class_resolver import resolve_class
from tests.utils.function_resolver import resolve_function
from tests.utils.yaml_loader import load_function_cases


def pytest_generate_tests(metafunc):
    if "case_data" in metafunc.fixturenames:
        test_file = Path(metafunc.definition.fspath)
        yaml_path = Path(*['resources' if part == 'test_cases' else part for part in test_file.parts])
        yaml_files = yaml_path.parent / f"{yaml_path.stem}.yml"
        functions = load_function_cases(yaml_files)
       # func_name = metafunc.function.__name__.replace("test_", "")
        func_name = metafunc.function.__name__
        if func_name.startswith("test_"):
            func_name = func_name[len("test_"):]
        if func_name not in functions:
            pytest.skip(f"No cases defined for {func_name} in {yaml_files}")

        params, ids = [], []
        for case in functions[func_name]['cases']:
            params.append(case)
            if isinstance(case, tuple):
                case_temp, _ = case
            else:
                case_temp = case
            ids.append(f"{case_temp['case_id']} ")

        metafunc.parametrize("case_data", params, ids=ids)


@pytest.fixture
def function_resolver():
    return resolve_function


@pytest.fixture
def class_resolver():
    return resolve_class
